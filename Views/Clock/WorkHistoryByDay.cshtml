@using SummerSplashWeb.Models
@{
    ViewData["Title"] = "Daily Work History";
    var users = ViewBag.Users as List<User> ?? new List<User>();
    var locations = ViewBag.Locations as List<JobLocation> ?? new List<JobLocation>();
    var selectedDate = (DateTime)ViewBag.SelectedDate;
    var clockRecords = ViewBag.ClockRecords as List<ClockRecord> ?? new List<ClockRecord>();
    var totalHours = (decimal)(ViewBag.TotalHours ?? 0m);
    var totalWorkers = (int)(ViewBag.TotalWorkers ?? 0);
}

<div class="content-area">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i class="bi bi-calendar-day me-2"></i>Daily Work History</h2>
            <p class="text-muted mb-0">View all employees who worked on a specific day</p>
        </div>
        <a href="@Url.Action("WorkHistory")" class="btn btn-outline-primary">
            <i class="bi bi-person me-1"></i>View by Employee
        </a>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>@TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Date Filter -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-calendar me-2"></i>Select Date</h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-semibold">Date</label>
                    <input type="date" name="date" class="form-control"
                           value="@selectedDate.ToString("yyyy-MM-dd")" />
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search me-1"></i>View
                    </button>
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group">
                        <a href="@Url.Action("WorkHistoryByDay", new { date = selectedDate.AddDays(-1) })" class="btn btn-outline-secondary">
                            <i class="bi bi-chevron-left"></i> Previous Day
                        </a>
                        <a href="@Url.Action("WorkHistoryByDay", new { date = DateTime.Today })" class="btn btn-outline-secondary">
                            Today
                        </a>
                        <a href="@Url.Action("WorkHistoryByDay", new { date = selectedDate.AddDays(1) })" class="btn btn-outline-secondary">
                            Next Day <i class="bi bi-chevron-right"></i>
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white h-100">
                <div class="card-body text-center">
                    <h3 class="mb-0">@selectedDate.ToString("dddd")</h3>
                    <h5>@selectedDate.ToString("MMMM d, yyyy")</h5>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success text-white h-100">
                <div class="card-body text-center">
                    <h6 class="mb-1">Total Workers</h6>
                    <h2 class="mb-0">@totalWorkers</h2>
                    <small>Employees clocked in</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info text-white h-100">
                <div class="card-body text-center">
                    <h6 class="mb-1">Total Hours</h6>
                    @{
                        var hrs = (int)totalHours;
                        var mins = (int)((totalHours - hrs) * 60);
                    }
                    <h2 class="mb-0">@hrs h @mins m</h2>
                    <small>Combined work time</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Workers Table -->
    @if (clockRecords.Any())
    {
        <div class="card">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-people me-2"></i>All Workers on @selectedDate.ToString("MMM d, yyyy")</h5>
                <span class="badge bg-light text-dark">@clockRecords.Count records</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Employee</th>
                                <th>Position</th>
                                <th>Location</th>
                                <th>Clock In</th>
                                <th>Clock Out</th>
                                <th>Hours Worked</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var record in clockRecords.OrderBy(r => r.ClockInTime))
                            {
                                var user = users.FirstOrDefault(u => u.UserId == record.UserId);
                                var location = locations.FirstOrDefault(l => l.LocationId == record.LocationId);
                                <tr>
                                    <td>
                                        <strong>@(record.UserName ?? (user != null ? $"{user.FirstName} {user.LastName}" : "Unknown"))</strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">@(user?.Position ?? "N/A")</span>
                                    </td>
                                    <td>@(location?.Name ?? record.LocationName ?? "N/A")</td>
                                    <td>
                                        <span class="badge bg-success">@record.ClockInTime.ToString("h:mm tt")</span>
                                    </td>
                                    <td>
                                        @if (record.ClockOutTime.HasValue)
                                        {
                                            <span class="badge bg-secondary">@record.ClockOutTime.Value.ToString("h:mm tt")</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning text-dark">Still Working</span>
                                        }
                                    </td>
                                    <td>
                                        @if (record.TotalHours.HasValue)
                                        {
                                            var recHrs = (int)record.TotalHours.Value;
                                            var recMins = (int)((record.TotalHours.Value - recHrs) * 60);
                                            <span class="fw-bold">@recHrs h @recMins m</span>
                                        }
                                        else
                                        {
                                            var currentDuration = DateTime.Now - record.ClockInTime;
                                            var curHrs = (int)currentDuration.TotalHours;
                                            var curMins = currentDuration.Minutes;
                                            <span class="text-success">@curHrs h @curMins m (active)</span>
                                        }
                                    </td>
                                    <td>
                                        @if (record.ClockOutTime.HasValue)
                                        {
                                            <span class="badge bg-secondary">Completed</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-success"><i class="bi bi-record-circle me-1"></i>Active</span>
                                        }
                                    </td>
                                    <td>
                                        <a href="@Url.Action("EditRecord", new { id = record.RecordId })" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-pencil"></i> Edit
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <th colspan="5" class="text-end">Total:</th>
                                <th><span class="badge bg-primary fs-6">@hrs h @mins m</span></th>
                                <th colspan="2"></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Position Breakdown -->
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Breakdown by Position</h5>
            </div>
            <div class="card-body">
                @{
                    var byPosition = clockRecords
                        .GroupBy(r => users.FirstOrDefault(u => u.UserId == r.UserId)?.Position ?? "Unknown")
                        .Select(g => new {
                            Position = g.Key,
                            Count = g.Count(),
                            Hours = g.Where(r => r.TotalHours.HasValue).Sum(r => r.TotalHours!.Value)
                        })
                        .OrderByDescending(x => x.Count);
                }
                <div class="row">
                    @foreach (var pos in byPosition)
                    {
                        var posHrs = (int)pos.Hours;
                        var posMins = (int)((pos.Hours - posHrs) * 60);
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="text-muted">@pos.Position</h6>
                                    <div class="d-flex justify-content-between">
                                        <span><strong>@pos.Count</strong> workers</span>
                                        <span><strong>@posHrs h @posMins m</strong></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="bi bi-calendar-x" style="font-size: 4rem; color: #ccc;"></i>
                <h4 class="mt-3 text-muted">No Records Found</h4>
                <p class="text-muted">No one clocked in on @selectedDate.ToString("MMMM d, yyyy")</p>
            </div>
        </div>
    }
</div>

@using SummerSplashWeb.Models
@{
    ViewData["Title"] = "Missed Punches";
    var users = ViewBag.Users as List<User> ?? new List<User>();
    var schedules = ViewBag.Schedules as List<Schedule> ?? new List<Schedule>();
    var clockRecords = ViewBag.ClockRecords as List<ClockRecord> ?? new List<ClockRecord>();
    var locations = ViewBag.Locations as List<JobLocation> ?? new List<JobLocation>();
    var selectedDate = (DateTime)ViewBag.SelectedDate;
    var gracePeriodMinutes = ViewBag.GracePeriodMinutes ?? 30;
}

<div class="content-area">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>Missed Punches / Late Arrivals</h2>
            <p class="text-muted mb-0">Track employees who missed their clock-in or arrived late</p>
        </div>
    </div>

    <!-- Date Filter -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-semibold">Select Date</label>
                    <input type="date" name="date" class="form-control"
                           value="@selectedDate.ToString("yyyy-MM-dd")" />
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search me-1"></i>View
                    </button>
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group">
                        <a href="@Url.Action("MissedPunches", new { date = selectedDate.AddDays(-1) })" class="btn btn-outline-secondary">
                            <i class="bi bi-chevron-left"></i> Previous Day
                        </a>
                        <a href="@Url.Action("MissedPunches", new { date = DateTime.Today })" class="btn btn-outline-secondary">
                            Today
                        </a>
                        <a href="@Url.Action("MissedPunches", new { date = selectedDate.AddDays(1) })" class="btn btn-outline-secondary">
                            Next Day <i class="bi bi-chevron-right"></i>
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    @{
        var now = DateTime.Now;
        var absentPunches = new List<(User User, Schedule Schedule, int MinutesOverdue)>();
        var notClockedInPunches = new List<(User User, Schedule Schedule, int MinutesOverdue)>();
        var latePunches = new List<(User User, Schedule Schedule, ClockRecord Record, int LateMinutes)>();
        var onTimePunches = new List<(User User, Schedule Schedule, ClockRecord Record)>();

        foreach (var schedule in schedules.Where(s => s.StartTime.HasValue && s.EndTime.HasValue))
        {
            var user = users.FirstOrDefault(u => u.UserId == schedule.UserId);
            if (user == null || !user.IsActive) continue;

            var scheduledStartTime = schedule.ScheduledDate.Date.Add(schedule.StartTime!.Value);
            var scheduledEndTime = schedule.ScheduledDate.Date.Add(schedule.EndTime!.Value);
            var graceDeadline = scheduledStartTime.AddMinutes(gracePeriodMinutes);
            var clockRecord = clockRecords.FirstOrDefault(r => r.UserId == schedule.UserId);

            if (clockRecord == null)
            {
                // No clock record
                var checkTime = selectedDate.Date == DateTime.Today ? now : scheduledEndTime;

                if (selectedDate.Date < DateTime.Today || (selectedDate.Date == DateTime.Today && checkTime >= scheduledEndTime))
                {
                    // Shift ended without clock-in = ABSENT
                    var minutesOverdue = (int)(scheduledEndTime - scheduledStartTime).TotalMinutes;
                    absentPunches.Add((user, schedule, minutesOverdue));
                }
                else if (selectedDate.Date == DateTime.Today && now > scheduledStartTime)
                {
                    // Shift started but not ended yet, no clock-in = NOT CLOCKED IN (waiting)
                    var minutesOverdue = (int)(now - scheduledStartTime).TotalMinutes;
                    notClockedInPunches.Add((user, schedule, minutesOverdue));
                }
            }
            else if (clockRecord.ClockInTime > graceDeadline)
            {
                // Clocked in more than 30 minutes late = LATE
                var lateMinutes = (int)(clockRecord.ClockInTime - scheduledStartTime).TotalMinutes;
                latePunches.Add((user, schedule, clockRecord, lateMinutes));
            }
            else if (clockRecord.ClockInTime > scheduledStartTime)
            {
                // Clocked in after start but within grace period = ON TIME (within grace)
                onTimePunches.Add((user, schedule, clockRecord));
            }
            else
            {
                // Clocked in on time or early = ON TIME
                onTimePunches.Add((user, schedule, clockRecord));
            }
        }
    }

    <!-- Summary Stats -->
    <div class="row mb-4">
        <div class="col">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Absent</h6>
                            <h2 class="mb-0">@absentPunches.Count</h2>
                            <small>Shift ended, no clock-in</small>
                        </div>
                        <i class="bi bi-x-circle-fill" style="font-size: 2.5rem; opacity: 0.5;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card bg-secondary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Not Clocked In</h6>
                            <h2 class="mb-0">@notClockedInPunches.Count</h2>
                            <small>Shift in progress</small>
                        </div>
                        <i class="bi bi-hourglass-split" style="font-size: 2.5rem; opacity: 0.5;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Late Arrivals</h6>
                            <h2 class="mb-0">@latePunches.Count</h2>
                            <small>30+ min after start</small>
                        </div>
                        <i class="bi bi-clock-history" style="font-size: 2.5rem; opacity: 0.5;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">On Time</h6>
                            <h2 class="mb-0">@onTimePunches.Count</h2>
                            <small>Within grace period</small>
                        </div>
                        <i class="bi bi-check-circle" style="font-size: 2.5rem; opacity: 0.5;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Total Scheduled</h6>
                            <h2 class="mb-0">@schedules.Count</h2>
                            <small>All shifts today</small>
                        </div>
                        <i class="bi bi-calendar-check" style="font-size: 2.5rem; opacity: 0.5;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Absent Table (RED) - Shift ended without clock-in -->
    @if (absentPunches.Any())
    {
        <div class="card mb-4 border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="bi bi-x-circle-fill me-2"></i>Absent - No Show (@absentPunches.Count)
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Employee</th>
                                <th>Position</th>
                                <th>Scheduled Shift</th>
                                <th>Location</th>
                                <th>Status</th>
                                <th>Missed Hours</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in absentPunches.OrderByDescending(x => x.MinutesOverdue))
                            {
                                var scheduledStart = item.Schedule.ScheduledDate.Date.Add(item.Schedule.StartTime!.Value);
                                var scheduledEnd = item.Schedule.ScheduledDate.Date.Add(item.Schedule.EndTime!.Value);
                                var location = locations.FirstOrDefault(l => l.LocationId == item.Schedule.LocationId);
                                <tr class="table-danger">
                                    <td>
                                        <strong>@item.User.FirstName @item.User.LastName</strong>
                                        <br /><small class="text-muted">@item.User.Email</small>
                                    </td>
                                    <td>@(item.User.Position ?? "N/A")</td>
                                    <td>
                                        @scheduledStart.ToString("h:mm tt") - @scheduledEnd.ToString("h:mm tt")
                                    </td>
                                    <td>@(location?.Name ?? item.Schedule.LocationName ?? "N/A")</td>
                                    <td>
                                        <span class="badge bg-danger">
                                            <i class="bi bi-x-circle-fill me-1"></i>ABSENT
                                        </span>
                                    </td>
                                    <td>
                                        @{
                                            var hrs = item.MinutesOverdue / 60;
                                            var mins = item.MinutesOverdue % 60;
                                        }
                                        <span class="text-danger fw-bold">
                                            @hrs h @mins m
                                        </span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    <!-- Not Clocked In Table (GRAY) - Shift in progress, waiting -->
    @if (notClockedInPunches.Any())
    {
        <div class="card mb-4 border-secondary">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-hourglass-split me-2"></i>Not Clocked In Yet (@notClockedInPunches.Count)
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Employee</th>
                                <th>Position</th>
                                <th>Scheduled Shift</th>
                                <th>Location</th>
                                <th>Status</th>
                                <th>Time Overdue</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in notClockedInPunches.OrderByDescending(x => x.MinutesOverdue))
                            {
                                var scheduledStart = item.Schedule.ScheduledDate.Date.Add(item.Schedule.StartTime!.Value);
                                var scheduledEnd = item.Schedule.ScheduledDate.Date.Add(item.Schedule.EndTime!.Value);
                                var graceDeadline = scheduledStart.AddMinutes(gracePeriodMinutes);
                                var location = locations.FirstOrDefault(l => l.LocationId == item.Schedule.LocationId);
                                var isPastGrace = DateTime.Now > graceDeadline;
                                <tr class="@(isPastGrace ? "table-warning" : "")">
                                    <td>
                                        <strong>@item.User.FirstName @item.User.LastName</strong>
                                        <br /><small class="text-muted">@item.User.Email</small>
                                    </td>
                                    <td>@(item.User.Position ?? "N/A")</td>
                                    <td>
                                        @scheduledStart.ToString("h:mm tt") - @scheduledEnd.ToString("h:mm tt")
                                    </td>
                                    <td>@(location?.Name ?? item.Schedule.LocationName ?? "N/A")</td>
                                    <td>
                                        @if (isPastGrace)
                                        {
                                            <span class="badge bg-warning text-dark">
                                                <i class="bi bi-exclamation-triangle me-1"></i>Past Grace Period
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">
                                                <i class="bi bi-clock me-1"></i>Waiting
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        @{
                                            var hrs = item.MinutesOverdue / 60;
                                            var mins = item.MinutesOverdue % 60;
                                        }
                                        <span class="@(isPastGrace ? "text-warning" : "text-muted") fw-bold">
                                            @if (hrs > 0)
                                            {
                                                @($"{hrs}h {mins}m overdue")
                                            }
                                            else
                                            {
                                                @($"{mins} min overdue")
                                            }
                                        </span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    <!-- Late Arrivals Table -->
    @if (latePunches.Any())
    {
        <div class="card mb-4 border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history me-2"></i>Late Arrivals (@latePunches.Count)
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Employee</th>
                                <th>Position</th>
                                <th>Scheduled</th>
                                <th>Actual Clock In</th>
                                <th>Location</th>
                                <th>Late By</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in latePunches.OrderByDescending(x => x.LateMinutes))
                            {
                                var scheduledTime = item.Schedule.ScheduledDate.Date.Add(item.Schedule.StartTime!.Value);
                                var location = locations.FirstOrDefault(l => l.LocationId == item.Schedule.LocationId);
                                <tr class="table-warning">
                                    <td>
                                        <strong>@item.User.FirstName @item.User.LastName</strong>
                                        <br /><small class="text-muted">@item.User.Email</small>
                                    </td>
                                    <td>@(item.User.Position ?? "N/A")</td>
                                    <td>@scheduledTime.ToString("h:mm tt")</td>
                                    <td>@item.Record.ClockInTime.ToString("h:mm tt")</td>
                                    <td>@(location?.Name ?? item.Record.LocationName ?? "N/A")</td>
                                    <td>
                                        @{
                                            var lateHrs = item.LateMinutes / 60;
                                            var lateMins = item.LateMinutes % 60;
                                        }
                                        <span class="badge bg-warning text-dark">
                                            @if (lateHrs > 0)
                                            {
                                                @($"{lateHrs}h {lateMins}m late")
                                            }
                                            else
                                            {
                                                @($"{lateMins} min late")
                                            }
                                        </span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    <!-- On Time Table -->
    @if (onTimePunches.Any())
    {
        <div class="card mb-4 border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-check-circle-fill me-2"></i>On Time (@onTimePunches.Count)
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Employee</th>
                                <th>Position</th>
                                <th>Scheduled</th>
                                <th>Actual Clock In</th>
                                <th>Location</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in onTimePunches)
                            {
                                var scheduledTime = item.Schedule.ScheduledDate.Date.Add(item.Schedule.StartTime!.Value);
                                var location = locations.FirstOrDefault(l => l.LocationId == item.Schedule.LocationId);
                                var earlyMinutes = (int)(scheduledTime - item.Record.ClockInTime).TotalMinutes;
                                <tr>
                                    <td>
                                        <strong>@item.User.FirstName @item.User.LastName</strong>
                                    </td>
                                    <td>@(item.User.Position ?? "N/A")</td>
                                    <td>@scheduledTime.ToString("h:mm tt")</td>
                                    <td>@item.Record.ClockInTime.ToString("h:mm tt")</td>
                                    <td>@(location?.Name ?? item.Record.LocationName ?? "N/A")</td>
                                    <td>
                                        @if (earlyMinutes > 0)
                                        {
                                            <span class="badge bg-success">@earlyMinutes min early</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-success">On time</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    @if (!schedules.Any())
    {
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="bi bi-calendar-x" style="font-size: 4rem; color: #ccc;"></i>
                <h4 class="mt-3 text-muted">No Schedules Found</h4>
                <p class="text-muted">There are no scheduled shifts for @selectedDate.ToString("MMMM d, yyyy")</p>
            </div>
        </div>
    }
</div>

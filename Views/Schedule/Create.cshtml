@model SummerSplashWeb.Models.Schedule
@using SummerSplashWeb.Models
@{
    ViewData["Title"] = "Create Schedule";
    var users = ViewBag.Users as List<User> ?? new List<User>();
    var locations = ViewBag.Locations as List<JobLocation> ?? new List<JobLocation>();
    var selectedDate = ViewBag.SelectedDate as DateTime? ?? DateTime.Now;
    var selectedUserId = ViewBag.SelectedUserId as int?;
}

<div class="content-area">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i class="bi bi-calendar-plus me-2"></i>Create Schedule</h2>
            <p class="text-muted mb-0">Add a new employee schedule</p>
        </div>
        <div>
            <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Back to Schedule
            </a>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <form asp-action="Create" method="post">
                @Html.AntiForgeryToken()
                <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label asp-for="UserId" class="form-label">
                            <i class="bi bi-person-circle me-1"></i>Employee <span class="text-danger">*</span>
                        </label>
                        <select asp-for="UserId" class="form-select" required>
                            <option value="">-- Select Employee --</option>
                            @foreach (var user in users.Where(u => u.IsActive).OrderBy(u => u.FirstName))
                            {
                                <option value="@user.UserId" selected="@(selectedUserId.HasValue && user.UserId == selectedUserId.Value)">
                                    @user.FirstName @user.LastName (@user.Position)
                                </option>
                            }
                        </select>
                        <span asp-validation-for="UserId" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="LocationId" class="form-label">
                            <i class="bi bi-geo-alt me-1"></i>Location <span class="text-danger">*</span>
                        </label>
                        <select asp-for="LocationId" class="form-select" required>
                            <option value="">-- Select Location --</option>
                            @foreach (var location in locations.Where(l => l.IsActive).OrderBy(l => l.Name))
                            {
                                <option value="@location.LocationId">@location.Name</option>
                            }
                        </select>
                        <span asp-validation-for="LocationId" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">
                            <i class="bi bi-calendar-event me-1"></i>From Date <span class="text-danger">*</span>
                        </label>
                        <input type="date" name="StartDateRange" id="startDateRange" class="form-control" value="@selectedDate.ToString("yyyy-MM-dd")" required />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">
                            <i class="bi bi-calendar-event-fill me-1"></i>To Date <span class="text-danger">*</span>
                        </label>
                        <input type="date" name="EndDateRange" id="endDateRange" class="form-control" value="@selectedDate.ToString("yyyy-MM-dd")" required />
                        <small class="text-muted" id="daysCountDisplay"></small>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="SupervisorId" class="form-label">
                            <i class="bi bi-person-badge me-1"></i>Supervisor (Optional)
                        </label>
                        <select asp-for="SupervisorId" class="form-select">
                            <option value="">-- No Supervisor --</option>
                            @foreach (var user in users.Where(u => u.IsActive && (u.Position == "Manager" || u.Position == "Supervisor")).OrderBy(u => u.FirstName))
                            {
                                <option value="@user.UserId">@user.FirstName @user.LastName</option>
                            }
                        </select>
                        <span asp-validation-for="SupervisorId" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="StartTime" class="form-label">
                            <i class="bi bi-clock me-1"></i>Start Time <span class="text-danger">*</span>
                        </label>
                        <input asp-for="StartTime" type="time" class="form-control" id="startTime" onchange="calculateHours()" required />
                        <span asp-validation-for="StartTime" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="EndTime" class="form-label">
                            <i class="bi bi-clock-fill me-1"></i>End Time <span class="text-danger">*</span>
                        </label>
                        <input asp-for="EndTime" type="time" class="form-control" id="endTime" onchange="calculateHours()" required />
                        <span asp-validation-for="EndTime" class="text-danger"></span>
                    </div>

                    <div class="col-md-12">
                        <div class="alert alert-info" id="hoursDisplay" style="display: none;">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Scheduled Hours:</strong> <span id="hoursValue">0</span> hours
                        </div>
                    </div>

                    <div class="col-md-12">
                        <label asp-for="Notes" class="form-label">
                            <i class="bi bi-sticky me-1"></i>Notes (Optional)
                        </label>
                        <textarea asp-for="Notes" class="form-control" rows="3" placeholder="Add any additional notes or instructions..."></textarea>
                        <span asp-validation-for="Notes" class="text-danger"></span>
                    </div>
                </div>

                <div class="mt-4 d-flex justify-content-between">
                    <a href="@Url.Action("Index")" class="btn btn-secondary">
                        <i class="bi bi-x-circle me-1"></i>Cancel
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i>Create Schedule
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        function calculateHours() {
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;

            if (startTime && endTime) {
                const start = new Date('2000-01-01 ' + startTime);
                const end = new Date('2000-01-01 ' + endTime);
                const hours = (end - start) / (1000 * 60 * 60);

                if (hours > 0) {
                    document.getElementById('hoursValue').textContent = hours.toFixed(2);
                    document.getElementById('hoursDisplay').style.display = 'block';
                    document.getElementById('hoursDisplay').className = 'alert alert-success';
                } else {
                    document.getElementById('hoursValue').textContent = hours.toFixed(2);
                    document.getElementById('hoursDisplay').style.display = 'block';
                    document.getElementById('hoursDisplay').className = 'alert alert-warning';
                }
            } else {
                document.getElementById('hoursDisplay').style.display = 'none';
            }
        }

        function updateDaysCount() {
            const startDate = new Date(document.getElementById('startDateRange').value);
            const endDate = new Date(document.getElementById('endDateRange').value);

            if (startDate && endDate && endDate >= startDate) {
                const diffTime = Math.abs(endDate - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                if (diffDays === 1) {
                    document.getElementById('daysCountDisplay').textContent = '1 day will be scheduled';
                } else {
                    document.getElementById('daysCountDisplay').textContent = diffDays + ' days will be scheduled';
                }
            } else {
                document.getElementById('daysCountDisplay').textContent = 'End date must be on or after start date';
            }
        }

        // Add event listeners and run on page load
        document.getElementById('startDateRange').addEventListener('change', updateDaysCount);
        document.getElementById('endDateRange').addEventListener('change', updateDaysCount);
        updateDaysCount(); // Run on page load
    </script>
}
